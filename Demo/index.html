<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScriptaV3 Compiler Demo</title>

    <!-- KaTeX CSS (needed for page styling) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        /* CodeMirror container styling */
        codemirror-editor {
            display: block;
            height: 100%;
            width: 100%;
        }
    </style>

    <!-- Import map to ensure CodeMirror packages share the same @codemirror/state instance -->
    <script type="importmap">
    {
        "imports": {
            "@codemirror/state": "https://esm.sh/@codemirror/state@6.4.1",
            "@codemirror/view": "https://esm.sh/@codemirror/view@6.26.0?external=@codemirror/state",
            "@codemirror/commands": "https://esm.sh/@codemirror/commands@6.3.3?external=@codemirror/state,@codemirror/view,@codemirror/language",
            "@codemirror/autocomplete": "https://esm.sh/@codemirror/autocomplete@6.15.0?external=@codemirror/state,@codemirror/view,@codemirror/language,@lezer/common",
            "@codemirror/language": "https://esm.sh/@codemirror/language@6.10.1?external=@codemirror/state,@codemirror/view,@lezer/common,@lezer/highlight,@lezer/lr",
            "@codemirror/search": "https://esm.sh/@codemirror/search@6.5.6?external=@codemirror/state,@codemirror/view",
            "@codemirror/lint": "https://esm.sh/@codemirror/lint@6.5.0?external=@codemirror/state,@codemirror/view",
            "@lezer/common": "https://esm.sh/@lezer/common@1.2.1",
            "@lezer/highlight": "https://esm.sh/@lezer/highlight@1.2.0?external=@lezer/common",
            "@lezer/lr": "https://esm.sh/@lezer/lr@1.4.0?external=@lezer/common",
            "codemirror": "https://esm.sh/codemirror@6.0.1?external=@codemirror/state,@codemirror/view,@codemirror/commands,@codemirror/autocomplete,@codemirror/language,@codemirror/search,@codemirror/lint"
        }
    }
    </script>

    <!-- Load CodeMirror custom element as ES module -->
    <script type="module" src="codemirror-element.js"></script>
</head>
<body>
    <div id="app"></div>

    <script src="main.js"></script>
    <script>
        // localStorage keys
        var OLD_STORAGE_KEY = 'scripta-demo-source';
        var STORAGE_KEY = 'scripta-demo-documents';

        // Load documents from localStorage
        var documentsJson = localStorage.getItem(STORAGE_KEY);
        var documents = [];

        if (documentsJson) {
            // Parse existing documents
            try {
                documents = JSON.parse(documentsJson);
            } catch (e) {
                console.error('Failed to parse documents:', e);
                documents = [];
            }
        } else {
            // Check for migration from old format
            var oldSource = localStorage.getItem(OLD_STORAGE_KEY);
            if (oldSource) {
                // Migrate old single document to new format
                documents = [{
                    id: 'doc-1',
                    title: extractTitle(oldSource),
                    content: oldSource
                }];
                // Save migrated documents and remove old key
                localStorage.setItem(STORAGE_KEY, JSON.stringify(documents));
                localStorage.removeItem(OLD_STORAGE_KEY);
            }
        }

        // Helper function to extract title from content
        function extractTitle(content) {
            var parts = content.split('| title\n');
            if (parts.length > 1) {
                var lines = parts[1].split('\n');
                if (lines.length > 0) {
                    return lines[0].trim() || 'Untitled';
                }
            }
            return 'Untitled';
        }

        // Initialize Elm app with flags
        var app = Elm.Main.init({
            node: document.getElementById('app'),
            flags: {
                documents: documents
            }
        });

        // Subscribe to saveDocuments port
        app.ports.saveDocuments.subscribe(function(docs) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));
        });

        // Subscribe to selectInEditor port - sync rendered text clicks to editor
        app.ports.selectInEditor.subscribe(function(selection) {
            // selection = { lineNumber, begin, end }
            var editorElement = document.querySelector('codemirror-editor');
            if (editorElement && editorElement.editor) {
                var editor = editorElement.editor;
                var doc = editor.state.doc;

                // Get the start position of the target line (1-indexed to 0-indexed)
                var lineStart = doc.line(selection.lineNumber).from;

                // Calculate absolute positions (end is inclusive, so add 1 for CodeMirror's exclusive range)
                var from = lineStart + selection.begin;
                var to = lineStart + selection.end + 1;

                // Use the setSyncHighlight effect (imported in codemirror-element.js)
                // We need to access it via the editor's custom property
                if (editorElement.setSyncHighlight) {
                    editor.dispatch({
                        effects: editorElement.setSyncHighlight({ from, to }),
                        scrollIntoView: true
                    });
                }

                // Focus the editor
                editor.focus();
            }
        });

        // Load KaTeX and initialize math-text custom element (V2 approach)
        function initKatex() {
            class MathText extends HTMLElement {
                constructor() {
                    super();
                }

                connectedCallback() {
                    this.attachShadow({mode: "open"});
                    this.shadowRoot.innerHTML =
                        katex.renderToString(
                            this.content,
                            {
                                throwOnError: false,
                                displayMode: this.display,
                                trust: true
                            }
                        );
                    let link = document.createElement('link');
                    link.setAttribute('rel', 'stylesheet');
                    link.setAttribute('href', 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css');
                    this.shadowRoot.appendChild(link);
                }
            }

            customElements.define('math-text', MathText);
        }

        // Load KaTeX script dynamically
        var katexJs = document.createElement('script');
        katexJs.type = 'text/javascript';
        katexJs.onload = function() {
            initKatex();
        };
        katexJs.src = "https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js";
        document.head.appendChild(katexJs);
    </script>
</body>
</html>
