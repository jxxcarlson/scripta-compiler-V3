<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScriptaV3 Compiler Demo</title>

    <!-- KaTeX CSS (needed for page styling) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="main.js"></script>
    <script>
        // localStorage keys
        var OLD_STORAGE_KEY = 'scripta-demo-source';
        var STORAGE_KEY = 'scripta-demo-documents';

        // Load documents from localStorage
        var documentsJson = localStorage.getItem(STORAGE_KEY);
        var documents = [];

        if (documentsJson) {
            // Parse existing documents
            try {
                documents = JSON.parse(documentsJson);
            } catch (e) {
                console.error('Failed to parse documents:', e);
                documents = [];
            }
        } else {
            // Check for migration from old format
            var oldSource = localStorage.getItem(OLD_STORAGE_KEY);
            if (oldSource) {
                // Migrate old single document to new format
                documents = [{
                    id: 'doc-1',
                    title: extractTitle(oldSource),
                    content: oldSource
                }];
                // Save migrated documents and remove old key
                localStorage.setItem(STORAGE_KEY, JSON.stringify(documents));
                localStorage.removeItem(OLD_STORAGE_KEY);
            }
        }

        // Helper function to extract title from content
        function extractTitle(content) {
            var parts = content.split('| title\n');
            if (parts.length > 1) {
                var lines = parts[1].split('\n');
                if (lines.length > 0) {
                    return lines[0].trim() || 'Untitled';
                }
            }
            return 'Untitled';
        }

        // Initialize Elm app with flags
        var app = Elm.Main.init({
            node: document.getElementById('app'),
            flags: {
                documents: documents
            }
        });

        // Subscribe to saveDocuments port
        app.ports.saveDocuments.subscribe(function(docs) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));
        });

        // Load KaTeX and initialize math-text custom element (V2 approach)
        function initKatex() {
            class MathText extends HTMLElement {
                constructor() {
                    super();
                }

                connectedCallback() {
                    this.attachShadow({mode: "open"});
                    this.shadowRoot.innerHTML =
                        katex.renderToString(
                            this.content,
                            {
                                throwOnError: false,
                                displayMode: this.display,
                                trust: true
                            }
                        );
                    let link = document.createElement('link');
                    link.setAttribute('rel', 'stylesheet');
                    link.setAttribute('href', 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css');
                    this.shadowRoot.appendChild(link);
                }
            }

            customElements.define('math-text', MathText);
        }

        // Load KaTeX script dynamically
        var katexJs = document.createElement('script');
        katexJs.type = 'text/javascript';
        katexJs.onload = function() {
            initKatex();
        };
        katexJs.src = "https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js";
        document.head.appendChild(katexJs);
    </script>
</body>
</html>
