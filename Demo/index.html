<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScriptaV3 Compiler Demo</title>

    <!-- KaTeX CSS (needed for page styling) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="main.js"></script>
    <script>
        // localStorage key for source text
        var STORAGE_KEY = 'scripta-demo-source';

        // Load saved source from localStorage
        var savedSource = localStorage.getItem(STORAGE_KEY);

        // Initialize Elm app with flags
        var app = Elm.Main.init({
            node: document.getElementById('app'),
            flags: {
                savedSource: savedSource
            }
        });

        // Subscribe to saveSource port
        app.ports.saveSource.subscribe(function(source) {
            localStorage.setItem(STORAGE_KEY, source);
        });

        // Load KaTeX and initialize math-text custom element (V2 approach)
        function initKatex() {
            class MathText extends HTMLElement {
                constructor() {
                    super();
                }

                connectedCallback() {
                    this.attachShadow({mode: "open"});
                    this.shadowRoot.innerHTML =
                        katex.renderToString(
                            this.content,
                            {
                                throwOnError: false,
                                displayMode: this.display,
                                trust: true
                            }
                        );
                    let link = document.createElement('link');
                    link.setAttribute('rel', 'stylesheet');
                    link.setAttribute('href', 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css');
                    this.shadowRoot.appendChild(link);
                }
            }

            customElements.define('math-text', MathText);
        }

        // Load KaTeX script dynamically
        var katexJs = document.createElement('script');
        katexJs.type = 'text/javascript';
        katexJs.onload = function() {
            initKatex();
        };
        katexJs.src = "https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js";
        document.head.appendChild(katexJs);
    </script>
</body>
</html>
