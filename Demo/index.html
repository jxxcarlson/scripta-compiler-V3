<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scripta Compiler Demo</title>

    <!-- KaTeX for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="main.js"></script>
    <script>
        // localStorage key for source text
        var STORAGE_KEY = 'scripta-demo-source';

        // Load saved source from localStorage
        var savedSource = localStorage.getItem(STORAGE_KEY);

        // Initialize Elm app with flags
        var app = Elm.Main.init({
            node: document.getElementById('app'),
            flags: {
                savedSource: savedSource
            }
        });

        // Subscribe to saveSource port
        app.ports.saveSource.subscribe(function(source) {
            localStorage.setItem(STORAGE_KEY, source);
        });

        // Custom element for math rendering with KaTeX
        class MathText extends HTMLElement {
            constructor() {
                super();
            }

            connectedCallback() {
                this.render();
            }

            static get observedAttributes() {
                return ['content', 'display'];
            }

            attributeChangedCallback(name, oldValue, newValue) {
                if (oldValue !== newValue) {
                    this.render();
                }
            }

            set content(value) {
                this._content = value;
                this.render();
            }

            get content() {
                return this._content || '';
            }

            set display(value) {
                this._display = value;
                this.render();
            }

            get display() {
                return this._display || false;
            }

            render() {
                if (typeof katex === 'undefined') {
                    // KaTeX not loaded yet, try again later
                    setTimeout(() => this.render(), 100);
                    return;
                }

                const content = this._content || this.getAttribute('content') || '';
                const displayMode = this._display || this.getAttribute('display') === 'true';

                try {
                    katex.render(content, this, {
                        displayMode: displayMode,
                        throwOnError: false,
                        errorColor: '#cc0000'
                    });
                } catch (e) {
                    this.innerHTML = '<span style="color: #cc0000;">' + e.message + '</span>';
                }
            }
        }

        // Register the custom element
        customElements.define('math-text', MathText);
    </script>
</body>
</html>
